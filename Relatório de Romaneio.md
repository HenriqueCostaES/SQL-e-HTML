```sql
WITH 
VOLUMES AS (
    SELECT
        P.CODPROD,
        ROW_NUMBER() OVER (PARTITION BY P.CODPROD ORDER BY B.CODBARRA) AS SEQUENCIA,
        COUNT(*) OVER (PARTITION BY P.CODPROD) AS TOTAL
    FROM TGFPRO P
    INNER JOIN TGFITE ITE2 ON ITE2.CODPROD = P.CODPROD AND ITE2.NUNOTA = :NOTA
    LEFT JOIN TGFVOA V ON V.CODPROD = P.CODPROD
    LEFT JOIN TGFBAR B ON B.CODVOL = NVL(V.CODVOL, P.CODVOL) AND B.CODPROD = P.CODPROD
    LEFT JOIN (SELECT ROWNUM AS QTD FROM TGFPRO WHERE ROWNUM <= 100) M
        ON M.QTD <= CASE
            WHEN (SELECT COUNT(1) FROM TGFBAR WHERE TGFBAR.CODVOL = V.CODVOL AND TGFBAR.CODPROD = P.CODPROD) = 0 THEN 0
            ELSE V.QUANTIDADE / (SELECT COUNT(1) FROM TGFBAR WHERE TGFBAR.CODVOL = V.CODVOL AND TGFBAR.CODPROD = P.CODPROD)
        END
),

LOCS_ACUMULADO AS (
    SELECT
        LOC.CODPROD,
        LOC.VLMDST,
        LOC.ID_LOC,
        LOC.QTDLOCAL,
        SUM(LOC.QTDLOCAL) OVER (PARTITION BY LOC.CODPROD, LOC.VLMDST ORDER BY LOC.ID_LOC) AS ACUMULADO
    FROM AD_LOCPROD LOC
),

FATORES AS (
    SELECT
        ITE.NUNOTA,
        ITE.CODPROD,
        ITE.SEQUENCIA,
        CASE
            WHEN VOA.CODPROD IS NULL THEN ITE.QTDNEG
            WHEN VOA.DIVIDEMULTIPLICA = 'D' THEN ITE.QTDNEG * VOA.QUANTIDADE
            ELSE ITE.QTDNEG / VOA.QUANTIDADE
        END AS QTD_NECESSARIA
    FROM TGFITE ITE
    LEFT JOIN TGFVOA VOA ON VOA.CODPROD = ITE.CODPROD 
                         AND VOA.CODVOL = ITE.CODVOL 
                         AND ( (ITE.CONTROLE IS NULL AND VOA.CONTROLE = ' ') 
                            OR (ITE.CONTROLE IS NOT NULL AND ITE.CONTROLE = VOA.CONTROLE) )
    WHERE ITE.NUNOTA = :NOTA
)

SELECT
    'OUTRO CD' AS TIPO,
    (SELECT DISTINCT PED.NUMNOTA 
     FROM TGFCAB CAB_INT, TGFVAR VAR, TGFCAB PED 
     WHERE CAB_INT.NUNOTA = VAR.NUNOTA 
       AND VAR.NUNOTAORIG = PED.NUNOTA 
       AND CAB_INT.AD_NUNOTA_REM_CD = ITE.NUNOTA) AS PEDIDO,
    NULL AS SEQUENCIA,
    NULL AS TOTAL,
    ITE.CODPROD,
    PRO.DESCRPROD,
    NULL AS DESCRICAO,
    NULL AS VLMDST,
    NULL AS QTDLOCAL,
    F.QTD_NECESSARIA AS QTDNEG
FROM TGFITE ITE
INNER JOIN TGFPRO PRO ON ITE.CODPROD = PRO.CODPROD
LEFT JOIN TGFCAB CAB ON CAB.NUNOTA = ITE.NUNOTA
LEFT JOIN FATORES F ON F.NUNOTA = ITE.NUNOTA AND F.CODPROD = ITE.CODPROD AND F.SEQUENCIA = ITE.SEQUENCIA
WHERE ITE.NUNOTA = :NOTA
  AND ITE.SEQUENCIA > 0
  AND (CAB.AD_CD <> 'CD3' OR CAB.AD_CD IS NULL)

UNION ALL


SELECT
    'CD 3' AS TIPO,
    (SELECT DISTINCT PED.NUMNOTA 
     FROM TGFCAB CAB_INT, TGFVAR VAR, TGFCAB PED 
     WHERE CAB_INT.NUNOTA = VAR.NUNOTA 
       AND VAR.NUNOTAORIG = PED.NUNOTA 
       AND CAB_INT.AD_NUNOTA_REM_CD = ITE.NUNOTA) AS PEDIDO,
    VOL.SEQUENCIA,
    VOL.TOTAL,
    ITE.CODPROD,
    PRO.DESCRPROD,
    CAO.DESCRICAO,
    LOC.VLMDST,
    LOC.QTDLOCAL,
    F.QTD_NECESSARIA AS QTDNEG
FROM TGFITE ITE
INNER JOIN TGFPRO PRO ON ITE.CODPROD = PRO.CODPROD
LEFT JOIN TGFCAB CAB ON CAB.NUNOTA = ITE.NUNOTA
LEFT JOIN VOLUMES VOL ON VOL.CODPROD = PRO.CODPROD

LEFT JOIN FATORES F ON F.NUNOTA = ITE.NUNOTA AND F.CODPROD = ITE.CODPROD AND F.SEQUENCIA = ITE.SEQUENCIA

LEFT JOIN LOCS_ACUMULADO LOC ON LOC.CODPROD = PRO.CODPROD 
                            AND LOC.VLMDST = VOL.SEQUENCIA
                            AND (LOC.ACUMULADO - LOC.QTDLOCAL) < F.QTD_NECESSARIA

LEFT JOIN AD_LOCALIZACAO CAO ON CAO.ID = LOC.ID_LOC
WHERE ITE.NUNOTA = :NOTA
  AND ITE.SEQUENCIA > 0
  AND CAB.AD_CD = 'CD3'
  


```
